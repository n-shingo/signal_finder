# 新規 : 2018-10-13
# 更新 : 2018-11-11 逆光画像の機能追加による更新

1.概要
    つくばチャレンジ2018用信号検出プログラム


2.コンパイルと実行

    A. コンパイル
       CMake でコンパイル．ssm, OpenCV(3.1.1, 3.1.4で動作済), spur kawlibが必要．
       コンパイルが成功すれば，binディレクトリに以下の３つの実行ファイルが生成される
       1) find-signal, 2) test-comand, 3) signal_test

   B. プログラムの実行
        1) find-signal  ... つくばチャレンジ本番用プログラム．信号の検出を行う．
                            必ず res ディレクトリに３つのテンプレート画像 red_signal_average, blu_signal_average,
                            blu_signal_backlight_average が置かれていること．
        2) test-command ... wp_gl構造体のstop_typeデータをssmに書き込むテスト用プログラム．
                            信号2を送信することで，find-signalプログラムに検出開始信号を送信できる．
        3) signal_test  ... SignalFinderクラスをテストするための単体プログラム．開発者専用プログラム．


3.信号検出アルゴリズム

    A. 全体の流れ
        信号検出アルゴリズムはSignalFinderクラスが行い，その中で以下の４状態が遷移する．
        アイドリング中は何もせず，外部から開始の合図で赤信号の検出を始める．
        赤信号を検出すると，青信号待ち状態となり，青信号が発見されるとアイドリング状態に戻る．

        0) アイドリング <--------------
              |                       |
<開始信号>--> |                       |
              v                       |
        1) 赤信号の検出 <----------   |
              |                    |  |
              |                    |  |
              v                    |  |
        2) 青信号待ち              |  |
              |                    |  |
              | -- 赤信号ロスト -->|  |
              v                       |
        3) 青信号検知 ---------------->

    B. 赤信号検出時のアルゴリズム
        1) 現在と過去を含めたN1(=5)枚の画像に対してHSVによる閾値処理を行い, 赤信号と思われる領域を検出．
           N1枚の領域画像の平均画像を取り, 閾値(=100)以上の場所を赤信号の領域候補とする.この時，領域候
           補の数が0であった場合は，移行の処理はせず次のフレームで再び1)を行う．
        2) 平均画像の各領域の重心を赤信号の中心座標とし,8枚の赤信号テンプレート画像との相関係数を求める．
           最良の相関係数が閾値(=0.6)以上であれば，赤信号の候補としてその画像と相関係数を記録しておく．
        3) 1), 2) の繰返しによって赤信号の候補がN2(=10)枚記録されたら，その中で最も相関係数が高い画像を，
           赤信号画像とし，赤信号検出できたとして青信号待ち状態に遷移する．この赤信号画像は新たなテンプ
           レート画像(T_r)として記録しておく．

    C. 青信号待ちのアルゴリズム
       1) B.赤信号検出 1)と同じアルゴリズムで，平均画像による赤信号の領域候補を決定する．
       2) 平均画像の各領域の重心を赤信号の中心座標とした位置の画像と，赤信号テンプレート画像(T_r)との相
          関係数を算出する．相関係数が閾値(=0.925)以上の領域があれば，最良の相関係数の領域の画像を新しい
          赤信号テンプレートとして T_r を更新し，1)へ戻って青信号待ちを続ける．
       3) 次に8枚の青信号テンプレートとの相関係数を求める．最良の相関係数が閾値(=0.925)以上の場合は，青色
          画像検出とする．そして，アイドリング状態に遷移する．
       4) 1)で領域候補がひとつもない，または，2)で青信号が検出できない場合は，赤信号が検出できなかった
          とし，N3(=10)フレーム連続で発生した場合は赤信号を見失ったとして，「B)赤信号検出」に遷移する．

